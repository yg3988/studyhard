# 병행성 : 교착상태와 기아상태

## 교착상태 원리

&nbsp;&nbsp;&nbsp;&nbsp;교착상태란 프로세스들의 집합이 더이상 진행을 못하고 영구적으로 블록되어 있는 상태로 시스템 자원에 대한 경쟁 도중에 발생할 수도 있고 프로세스 간 통신 도중에 발생할 수도 있다. 교착상태가 영구적인 이유는 기다리던 사건이 결코 발생하지 않기 때문이다. 다른 병행 프로세스 관리 문제들과는 달리, 모든 교착상태에 적용될 수 있는 효과적인 해결책은 아직 제안되지 않았다.

&nbsp;&nbsp;&nbsp;&nbsp;교착상태는 두 개 이상의 프로세스들이 서로 충돌되는 자원 요구를 할 때 발생한다. 교착상태의 대표적인 예는 교통 교착상태이다.

![os59](../.src/os59.jpg)

교차로의 네 구역(a, b, c, d)은 제어가 필요한 공유 자원이 된다. 일단 각 차들이 직진하려고 한다고 가정하자. 그럼, 사거리 교차로에서 각 차들이 원하는 자원은 다음과 같다.

* 차 1 : 북쪽으로 진행 중. 구역 a, b가 필요
* 차 2 : 서쪽으로 진행 중. 구역 b, c가 필요
* 차 3 : 남쪽으로 진행 중. 구역 c, d가 필요
* 차 4 : 동쪽으로 진행 중. 구역 d, a가 필요

&nbsp;&nbsp;&nbsp;&nbsp;각 차는 필요한 두 개의 구역 중 하나를 차지하고 다른 하나의 구역을 다른 차가 차지하는 경우 더 이상 진행하지 못함.

&nbsp;&nbsp;&nbsp;&nbsp;사거리 교차로에서 흔히 적용되는 규칙은 오른쪽 차 우선 규칙이다. 예를 들어 북쪽으로 직진하려는 차와 서쪽으로 직진하려는 차가 교차로에 진입하려 할 때, 서쪽으로 직진하려는 차는 진행하고 북쪽으로 직진하려는 차는 일단 멈추는 것이다. 이 규칙은 교차로에 두 대 또는 세 대의 차가 있을 때에는 잘 작동한다. 하지만 네 대의 차가 사거리 교차로의 모든 진입로에 동시에 들어오면 이 규칙은 제대로 동작하지 않는다. 규칙을 지키면 모든 차가 더 이상 진입을 못하는 상태, 즉 교착상태가 된다.

&nbsp;&nbsp;&nbsp;&nbsp;프로세스와 자원 관계에서 교착 상태를 살펴보자

![os60](../.src/os60.jpg)

위 그림은 P와 Q라는 두 개의 프로세스가 A와 B라는 자원을 경쟁적으로 사용하며 수행하는 과정을 보여준다. 이 그림은 결합 진행 다이어 그램이라 불린다. 각 프로세스는 일정 기간동안 두 개의 자원을 동시에 배타적으로 사용해야 한다. 프로세스 P와 Q의 수행을 가상 코드로 살펴보면 다음과 같다.

![os61](../.src/os61.jpg)

위 도표에서 x축은 프로세스 P의 진행을 y축은 프로세스 Q의 진행을 나타낸다. 프로세스가 병행 수행되면 진행 경로는 그림 내부의 화살표처럼 원점에서 시작하여 북동쪽 방향으로 움직이는 경로가 된다. 단일 처리기의 경우, 한 시점에 수행되는 프로세스가 하나밖에 없으며 따라서 진행 경로는 수평 또는 수직 방향으로만 움직이게 된다. 즉, 원점에서 출발하여 P가 수행하면 오른쪽 수평 방향으로, Q가 수행하면 위쪽 수직 방향으로 진행한다. 한편, 그림에서 두 프로세스들이 동시에 자원 A를 할당받은 영역은 상향 대각선으로 채워져 있다. 두 프로세스들이 동시에 자원B를 할당 받은 영역은 하향 대각선으로 채워져 있다. 그리고 두 프로세스들이 동시에 두 자원을 모두 할당 받은 영역은 상향 대각선과 하향 대각선이 모두 채워져 있다. 하지만, 프로세스는 자원을 독점적으로 사용하여야 한다. 따라서 상향 또는 하향 대각선으로 채워진 영역은 실제로는 진행경로가 진입할 수 없는 영역이 된다.

&nbsp;&nbsp;&nbsp;&nbsp;도표는 여섯 가지 서로 다른 수행 경로를 보여준다. 이들은 다음과 같이 요약될 수 있다.

1. 프로세스 Q가 자원 B를 획득하고 그 이후에는 다시 자원 A를 획득한다. 수행 완료 이후 프로세스 Q는 두 자원을 반납한다. 이제 프로세스 P가 수행되면 두 자원을 사용할 수 있다.

2. 프로세스 Q가 자원 B를 획득하고 이후 다시 자원 A를 획득한다. 이 때 프로세스 P가 수행된다. 하지만 P는 자원 A의 획득에 실패하고 블록된다. 프로세스 Q가 수행을 완료하고 자원들을 반납한다. 블록되었던 프로세스 P가 깨어나면 두 자원을 사용할 수 있다.

3. 프로세스 Q가 자원 B를 획득하고 프로세스 P가 자원 A를 획득한다. 프로세스 Q는 자원 A의 획득을 시도하다가 블록되고, 프로세스 P는 자원 B의 획득을 시도하다가 블록된다. 그런데 프로세스들이 서로를 기다리며 블록되어 있기 때문에 더이상 진행 될 수 없다. 교착상태가 발생한 것이다.

4. 프로세스 P가 자원 A를 획득하고 프로세스 Q가 자원 B를 획득한다. 프로세스 P는 자원 B의 획득을 시도하다가 블록되고, 프로세스 Q는 자원 A의 획득을 시도하다가 블록된다. 이 경우도 교착상태다.

5. 프로세스 P가 자원 A를 획득하고 그 이후에 다시 자원 B를 획득한다. 이때 프로세스 Q가 수행된다. 하지만 Q는 자원 B의 획득에 실패하고 블록된다. 프로세스 P가 수행을 완료하고 자원을 반납한다.

6. 프로세스 P가 자원 A를 획득하고 그 이후 다시 자원 B를 획득한다. 수행 완료 이후 프로세스 P는 자원을 반납한다. 이제 프로세스 Q가 수행되면 주 자원을 사용할 수 있다.

&nbsp;&nbsp;&nbsp;&nbsp;위 도표에서 회색으로 칠해진 영역을 치명적인 영역이라고하자. 프로세스들의 수행 경로가 치명적인 영역으로 진입하면 교착상태는 피할 수 없다. 치명적인 영역의 존재 여부는 두 프로세스의 로직에 의해 결정된다. 교착상태의 발생 여부는 두 프로세스의 결합 수행 경로가 치명적인 영역으로 진입하는가에 의해 결정된다.

&nbsp;&nbsp;&nbsp;&nbsp;교착상태의 발생은 동적인 프로세스 수행 과정뿐만 아니라 응용의 세부사항에도 영향을 받는다. 예를 들어 프로세스 P가 자원 A와 B를 동시에 사용하지 않는다고 가정해보자.

![os62](../.src/os62.jpg)

수정된 프로그램에 대한 프로세스 P와 Q의 진행 경로는 다음과 같다.

![os63](../.src/os63.jpg)

그림에서 알수 있듯이 이 시나리오에서는 두 프로세스의 상대적인 수행 속도와 무관하게 교착상태가 발생하지 않는다.


### 재사용 가능한 자원

&nbsp;&nbsp;&nbsp;&nbsp;프로세스가 사용하는 자원은 크게 두 종류로 구분할 수 있따. 하나는 재사용 가능한 자원이고 다른 하나는 소모성 자원이다. 우선 재사용 가능한 자원에 대해서 논의해보자. 재사용 가능한 자원은 프로세스의 사용에 의해 없어지지 않는 자원이다. 따라서 프로세스가 사용한 후 다른 프로세스가 다시 사용할 수 있도록 반납한다. 프로세서, 입출력채널, 주/보조 메모리, 장치, 파일이나 데이터베이스나 세마포어와 같은 자료 구조 등이 재사용 가능한 자원의 대표적인 예이다.

### 소모성 자원

&nbsp;&nbsp;&nbsp;&nbsp;소모성 자원은 생성되었다가 사용된 이후 소멸되는 자원이다. 보통, 소모성 자원에는 개수의 제한이 없다. 블록되지 않은 생산 프로세스는 자원을 몇 개라도 생산할 수 있다. 자원이 소비 프로세스에 의해 사용되면, 그 자원은 사라진다. 소모성 자원의 대표적인 예는 인터럽트, 시그널, 메시지, 입출력 버퍼 내의 정보이다.

### 자원 할당 그래프

&nbsp;&nbsp;&nbsp;&nbsp;자원 할당 그래프는 프로세스와 자원 할당 관계를 표현하는데 유용한 도구로 Holt에 의해 제안되었다. 자원 할당 그래프는 유향 그래프로 자원과 프로세스가 노드가 된다. 일반적으로 자원은 사각형으로 표현하며, 프로세스는 원으로 표현한다. 프로세스에서 자원으로 향한 링크는 프로세스가 그 자원을 원하고 있지만 아직 할당은 되지 않은 상태임을 의미한다.

![os64](../.src/os64.jpg)

이 그림에서 자원으로 나타내는 사각형 노드 내부에 점이 있는 것을 알 수 있다. 각 점은 그 자원의 인스턴스를 의미한다. 특정 자원은 가용 개수가 여러 개일 수 있는데, 예를 들어 생산자와 소비자 문제에서 생산자가 세 개의 데이터를 생산했다면, 이 경우 공유 버퍼 자원에서 자원 인스턴수 개수는 3이 된다.

&nbsp;&nbsp;&nbsp;&nbsp;재사용 가능한 자원의 경우, 자원의 점에서 프로세스로 향한 링크는 프로세스가 그자원을 할당하였음을 의미한다. 소모성 자원의 경우, 자원의 점에서 프로세스로 향한 링크는 그 프로세스가 자원의 생산자임을 의미한다.

### 교착상태 조건

##### 필요 조건
1. 상호 배재 조건
  * 한 순간에 한 프로세스만이 자원을 사용하 수 있음
2. 점유대기 조건
  * 자원을 요청하여 기다리는 프로세스가 이미 할당된 자원을 점유하고 있음
3. 비선점 조건
  * 프로세스에 의해 점유된 자원을 다른 프로세스가 강제적으로 빼앗을수 없다. 이는 OS의 자원 관리 정책이다.

##### 충분 조건
4. 환형 대기 조건
  * 프로세스들 간에 닫힌 연결을 이루고, 닫힌 연결에서 블록된 프로세스가 자원을 점유하고 있는데, 이 자원을 체인 내부의 다른 프로세스가 원하며 대기하고 있다. 이는 OS의 정책에 의해 교착상태가 발생한 상태라고 말할 수 있다.

&nbsp;&nbsp;&nbsp;&nbsp;조건 4는 조건 1~3의 결과에 의해 발생한다. 즉, 조건 1~3의 복잡한 상호작용의 결과 해결할 수 없는 환형 대기 상태가 발생하게 되는 것이다. 교착상태의 정의가 바로 해결할 수 없는 환형 대기 상태이다.

&nbsp;&nbsp;&nbsp;&nbsp;교착 상태란 프로세스들의 수행 과정 중에 환형 대기 조건이 발생한 것이다.

| 교착상태 가능 | 교착상태 발생 |
| :------------- | :------------- |
| 상호 배재 조건 | 상호 배재 조건 |
| 점유대기 조건 | 점유대기 조건 |
| 비선점 조건 | 비선점 조건 |
|| 환형 대기 조건|

### 교착상태 해결을 위한 접근 방법

1. 교착상태 예방
  * 교착 상태의 발생 조건 1~4 중에 하나를 시스템에서 호용하지 않는 것이다.
2. 교착상태 회피
  * 현재 자원 할당의 상태에 따라 안전하게 자원할당을 결정하는 것이다. 즉, 자원 할당 요구 시 교착상태가 발생 가능한 상황으로 진행하지 않도록 자원 할당을 결정하는 방법
3. 교착상태 발견 및 회복
  * 자원을 할당 한 후 교착상태가 발생하면 그것을 발견하고 회복하는 방법

## 교착상태 예방
